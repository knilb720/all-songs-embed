<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrick Boylan's Song List</title>
    
    <!-- EmailJS Script -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){
            emailjs.init('X0pllflr_hw5gcmEB');
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #000000;
            color: #ffffff;
            padding: 40px 20px 20px 20px;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            overflow-x: hidden;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            color: #ffffff;
        }

        /* Filter buttons container */
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
            padding: 20px 0;
        }

        /* Filter button styling - dark mode */
        .filter-btn {
            background-color: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-btn.active {
            background-color: #ffffff;
            color: #000000;
        }

        /* Search container */
        .search-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            padding: 0 10px;
            position: relative;
            transition: transform 0.25s cubic-bezier(0.25, 0.1, 0.25, 1),
                        padding 0.25s cubic-bezier(0.25, 0.1, 0.25, 1),
                        box-shadow 0.25s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        /* No sticky positioning - using min-height on table instead */

        .search-input {
            width: 100%;
            max-width: 500px;
            padding: 12px 20px;
            font-size: 16px;
            background-color: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            border-radius: 8px;
            font-family: inherit;
        }

        .search-input::placeholder {
            color: #888888;
        }

        /* Error message row - hidden by default */
        .error-message {
            display: none !important;
        }

        .error-message.show {
            display: table !important; /* Match tbody tr display */
        }

        .notify-btn {
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #ffffff;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Song table wrapper */
        .songlist-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 60vh; /* Add space below table to keep search bar position stable */
            display: block;
        }

        /* Song table styling - dark mode */
        .songlist-table {
            border-collapse: collapse;
        }

        .songlist-table tbody {
            display: block; /* Required for height/overflow to work on tbody */
            width: 100%;
            max-width: 900px;
            height: calc(100vh - 450px); /* Fixed height: viewport minus header/filters/search */
            overflow-y: auto; /* Internal scrolling */
            overflow-x: hidden;
            padding-bottom: 150px; /* Extra space for keyboard clearance (~3 rows) */
            overscroll-behavior: none; /* Prevent bounce effect at scroll boundaries */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .songlist-table thead {
            display: table; /* Keep header as table */
            width: 100%;
            table-layout: fixed;
        }

        .songlist-table tbody tr {
            display: table; /* Make rows behave like table */
            width: 100%;
            table-layout: fixed;
        }

        /* Mobile optimization - ensure table fits in viewport */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
                /* Allow page scroll for scroll chaining */
            }
            
            .songlist-wrapper {
                overflow-x: visible;
                padding: 0;
                margin: 0;
            }
            
            .songlist-table {
                width: 100%;
                table-layout: fixed;
            }

            .songlist-table tbody {
                height: calc(100vh - 400px); /* Adjust for mobile: viewport minus header/filters/search */
            }
        }

        .songlist-table th,
        .songlist-table td {
            text-align: left;
            padding: 12px 15px;
            font-size: 16px;
            color: #ffffff;
            height: 50px; /* Fixed height - rows don't expand */
            max-height: 50px;
        }

        .songlist-table th {
            font-weight: bold;
            border-bottom: 2px solid #333333;
            background-color: #111111;
        }

        /* No sticky headers needed with auto-scroll approach */

        .songlist-table tr:not(:first-child) td {
            border-bottom: 1px solid #222222;
        }

        /* Column widths */
        .songlist-table th:nth-child(1),
        .songlist-table td:nth-child(1) {
            width: 40%;
        }

        .songlist-table th:nth-child(2),
        .songlist-table td:nth-child(2) {
            width: 40%;
        }

        .songlist-table th:nth-child(3),
        .songlist-table td:nth-child(3) {
            width: 20%;
            text-align: right;
        }

        /* Request button styling - dark mode */
        .request-btn {
            background-color: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            white-space: nowrap;
        }

        /* Highlight search results */
        .highlight {
            background-color: #333333;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 40px 10px 20px 10px;
                max-width: 100vw;
                overflow-x: hidden;
            }

            h1 {
                font-size: 1.5em;
                margin-bottom: 20px;
            }

            .filter-buttons {
                gap: 10px;
                padding: 15px 0;
                margin-bottom: 15px;
            }

            .filter-btn {
                padding: 10px 16px;
                font-size: 12px;
            }

            .search-input {
                max-width: 100%;
                font-size: 16px;
            }

            .error-message p {
                font-size: 14px;
            }

            .songlist-table th,
            .songlist-table td {
                padding: 10px 8px;
                font-size: 14px;
            }

            /* Adjust column widths for mobile */
            .songlist-table th:nth-child(1),
            .songlist-table td:nth-child(1) {
                width: 35%;
            }

            .songlist-table th:nth-child(2),
            .songlist-table td:nth-child(2) {
                width: 40%;
            }

            .songlist-table th:nth-child(3),
            .songlist-table td:nth-child(3) {
                width: 25%;
            }

            .request-btn {
                padding: 6px 14px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <h1>Patrick Boylan's Song List</h1>

    <!-- Filter Buttons -->
    <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all">All Songs</button>
        <button class="filter-btn" data-filter="Musicals">Musicals</button>
        <button class="filter-btn" data-filter="Classic Piano Bar Tunes">Classic Piano Bar Tunes</button>
        <button class="filter-btn" data-filter="Disney">Disney</button>
        <button class="filter-btn" data-filter="2000-Present">2000-Present</button>
        <button class="filter-btn" data-filter="90's">90's</button>
        <button class="filter-btn" data-filter="60's-80's">60's-80's</button>
        <button class="filter-btn" data-filter="Jazz">Jazz</button>
        <button class="filter-btn" data-filter="Holiday">Holiday</button>
    </div>

    <!-- Search Bar -->
    <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Search for song">
    </div>

    <!-- Song Table -->
    <div class="songlist-wrapper">
        <table class="songlist-table" id="songTable">
            <thead>
                <tr>
                    <th>Song Title</th>
                    <th>Artist / Show</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="songBody">
                <!-- Songs will be loaded here via JavaScript -->
                <!-- Error Message Row - hidden by default, shown when no songs match -->
                <tr class="error-message" id="errorMessage">
                    <td colspan="3" style="text-align: center; padding: 20px;">
                        <p id="errorText" style="margin: 0 0 15px 0; font-size: 16px;">Oops! Looks like Pat doesn't know "<span id="searchTerm"></span>"</p>
                        <button class="notify-btn" id="notifyBtn">Click to tell him to learn it!</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        let allSongs = [];
        let currentFilter = 'all';
        let currentSearchTerm = '';

        // Levenshtein Distance - measures similarity between two strings
        function levenshteinDistance(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;
            const matrix = [];

            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    if (str1.charAt(i - 1) === str2.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[len1][len2];
        }

        // Progressive substring search with fuzzy matching - 30% more lenient
        function fuzzySearch(searchTerm, songs) {
            if (!searchTerm || searchTerm.trim() === '') {
                return songs;
            }

            const term = searchTerm.toLowerCase().trim();
            const results = [];

            songs.forEach(song => {
                const title = song.title.toLowerCase();
                const artist = song.artist.toLowerCase();
                let bestScore = Infinity;
                let matchType = '';
                
                // 1. Exact substring match (highest priority)
                if (title.includes(term) || artist.includes(term)) {
                    const titleStartsWith = title.startsWith(term);
                    const artistStartsWith = artist.startsWith(term);
                    const titleWordStart = title.split(/\s+/).some(word => word.startsWith(term));
                    const artistWordStart = artist.split(/\s+/).some(word => word.startsWith(term));
                    
                    if (titleStartsWith) bestScore = 0;
                    else if (artistStartsWith) bestScore = 1;
                    else if (titleWordStart) bestScore = 2;
                    else if (artistWordStart) bestScore = 3;
                    else if (title.includes(term)) bestScore = 4;
                    else if (artist.includes(term)) bestScore = 5;
                    
                    matchType = 'substring';
                }
                // 2. Fuzzy matching for typos (30% more lenient)
                else {
                    const titleWords = title.split(/\s+/);
                    const artistWords = artist.split(/\s+/);
                    
                    // Check each word in title and artist
                    [...titleWords, ...artistWords].forEach(word => {
                        const distance = levenshteinDistance(term, word);
                        const maxLen = Math.max(term.length, word.length);
                        const similarity = 1 - (distance / maxLen);
                        
                        // 40% similarity threshold (30% more lenient than 10%)
                        if (similarity >= 0.4) {
                            const score = 10 + distance; // Lower distance = better score
                            if (score < bestScore) {
                                bestScore = score;
                                matchType = 'fuzzy';
                            }
                        }
                    });
                }
                
                // Add to results if we found a match
                if (bestScore < Infinity) {
                    results.push({
                        song: song,
                        score: bestScore,
                        matchType: matchType
                    });
                }
            });

            // Sort by score (lower is better)
            results.sort((a, b) => {
                if (a.matchType === 'exact' && b.matchType !== 'exact') return -1;
                if (a.matchType !== 'exact' && b.matchType === 'exact') return 1;
                return a.score - b.score;
            });

            return results.map(r => r.song);
        }

        // Load songs from JSON
        async function loadSongs() {
            try {
                const response = await fetch('songs.json');
                allSongs = await response.json();
                renderSongs();
            } catch (error) {
                console.error('Error loading songs:', error);
                document.getElementById('songBody').innerHTML = 
                    '<tr><td colspan="3" style="text-align: center; padding: 20px;">Error loading songs. Please try again later.</td></tr>';
            }
        }

        // Render songs based on current filter and search
        function renderSongs() {
            const tbody = document.getElementById('songBody');
            const errorMessage = document.getElementById('errorMessage');
            
            // Clear only song rows, keep error message row
            const rows = tbody.querySelectorAll('tr:not(.error-message)');
            rows.forEach(row => row.remove());

            // Filter by category first
            let filteredSongs = allSongs;
            if (currentFilter !== 'all') {
                filteredSongs = allSongs.filter(song => 
                    song.tags && song.tags.includes(currentFilter)
                );
            }

            // Apply search if there's a search term
            if (currentSearchTerm) {
                filteredSongs = fuzzySearch(currentSearchTerm, filteredSongs);
            }

            // Show error if no results
            if (currentSearchTerm && filteredSongs.length === 0) {
                errorMessage.classList.add('show');
                document.getElementById('searchTerm').textContent = currentSearchTerm;
            } else {
                errorMessage.classList.remove('show');
            }

            // Sort alphabetically by title
            filteredSongs.sort((a, b) => 
                a.title.toLowerCase().localeCompare(b.title.toLowerCase())
            );

            // Render songs
            filteredSongs.forEach(song => {
                const row = document.createElement('tr');
                
                const titleCell = document.createElement('td');
                titleCell.textContent = song.title;
                
                const artistCell = document.createElement('td');
                artistCell.textContent = song.artist;
                
                const requestCell = document.createElement('td');
                const requestLink = document.createElement('a');
                requestLink.href = `venmo://paycharge?txn=pay&recipients=patrickTSG&amount=5&note=Song Request: ${encodeURIComponent(song.title + ' - ' + song.artist)}`;
                requestLink.className = 'request-btn';
                requestLink.textContent = 'Request';
                requestCell.appendChild(requestLink);
                
                row.appendChild(titleCell);
                row.appendChild(artistCell);
                row.appendChild(requestCell);
                
                tbody.appendChild(row);
            });
        }

        // Track if search is active to prevent unwanted scrolling
        let isSearchActive = false;
        let scrollPosition = 0;

        // Auto-scroll search bar to top when focused on mobile
        const searchInput = document.getElementById('searchInput');
        const searchContainer = document.querySelector('.search-container');
        
        searchInput.addEventListener('focus', function() {
            // Only auto-scroll on mobile (screen width < 768px)
            if (window.innerWidth < 768 && !isSearchActive) {
                // Smooth scroll to bring search bar to top of viewport
                setTimeout(() => {
                    searchContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Lock scroll position after scrolling
                    setTimeout(() => {
                        isSearchActive = true;
                        scrollPosition = window.pageYOffset;
                    }, 400); // Wait for smooth scroll to complete
                }, 100); // Small delay to let keyboard animation start
            }
        });

        searchInput.addEventListener('blur', function() {
            // Reset when keyboard closes
            isSearchActive = false;
        });

        // Live search - filter as user types WITHOUT scrolling
        searchInput.addEventListener('input', function() {
            currentSearchTerm = this.value;
            
            // Save current scroll position before rendering
            if (isSearchActive) {
                scrollPosition = window.pageYOffset;
            }
            
            renderSongs();
            
            // Restore scroll position after rendering to prevent movement
            if (isSearchActive) {
                window.scrollTo(0, scrollPosition);
            }
        });

        // Scroll chaining: Allow page scroll when tbody reaches top
        const tbody = document.getElementById('songBody');
        let lastScrollTop = 0;
        
        tbody.addEventListener('scroll', function(e) {
            const currentScrollTop = this.scrollTop;
            const scrollingUp = currentScrollTop < lastScrollTop;
            
            // If scrolling up and at the top of tbody, allow page scroll
            if (scrollingUp && currentScrollTop === 0) {
                // Don't prevent default - allow scroll to chain to page
                return;
            }
            
            lastScrollTop = currentScrollTop;
        }, { passive: true });
        
        // Handle touch events for smooth scroll chaining on mobile
        let touchStartY = 0;
        let touchStartTime = 0;
        let lastTouchY = 0;
        let velocity = 0;
        
        tbody.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
            lastTouchY = touchStartY;
            touchStartTime = Date.now();
            velocity = 0;
        }, { passive: true });
        
        tbody.addEventListener('touchmove', function(e) {
            const touchY = e.touches[0].clientY;
            const touchDelta = touchY - lastTouchY;
            const timeDelta = Date.now() - touchStartTime;
            
            // Calculate velocity
            if (timeDelta > 0) {
                velocity = touchDelta / timeDelta;
            }
            
            // If at top of tbody and trying to scroll up, manually scroll the page
            if (this.scrollTop === 0 && touchDelta > 0) {
                // Prevent tbody from handling this scroll
                e.preventDefault();
                // Manually scroll the page
                window.scrollBy(0, -touchDelta * 2); // Amplify for smooth feel
            }
            
            lastTouchY = touchY;
        }, { passive: false });
        
        tbody.addEventListener('touchend', function(e) {
            // If we had upward velocity at the top, continue scrolling the page
            if (this.scrollTop === 0 && velocity > 0.5) {
                // Smooth momentum scroll on the page
                let momentum = velocity * 500;
                const startScroll = window.pageYOffset;
                const startTime = Date.now();
                
                function momentumScroll() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / 300, 1); // 300ms duration
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    
                    window.scrollTo(0, startScroll - (momentum * easeOut));
                    
                    if (progress < 1 && window.pageYOffset > 0) {
                        requestAnimationFrame(momentumScroll);
                    }
                }
                
                requestAnimationFrame(momentumScroll);
            }
        }, { passive: true });

        // Filter button click handlers
        document.querySelectorAll('.filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('.filter-btn').forEach(btn => 
                    btn.classList.remove('active')
                );
                this.classList.add('active');

                // Update filter and re-render
                currentFilter = this.getAttribute('data-filter');
                renderSongs();
            });
        });

        // Notify button - EmailJS Integration
        document.getElementById('notifyBtn').addEventListener('click', function() {
            const searchTerm = document.getElementById('searchTerm').textContent;
            
            // Send email via EmailJS
            emailjs.send('service_aziu0jh', 'template_fkk6b0b', {
                song_request: searchTerm
            }).then(
                function(response) {
                    alert('Thanks! Pat has been notified to learn "' + searchTerm + '"!');
                    console.log('Email sent successfully!', response.status, response.text);
                },
                function(error) {
                    alert('Oops! Something went wrong. Please try again.');
                    console.log('Email failed to send:', error);
                }
            );
        });

        // Load songs on page load
        loadSongs();
    </script>
</body>
</html>
